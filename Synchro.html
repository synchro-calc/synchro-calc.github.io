<!DOCTYPE html>
<html>
<head>
    <title>Synchro Calculator</title>
    <style>
    .spell-grid-container {
        width : 60%;
        display: grid;
        background-color: #1E1F1B;
        padding: 1px;
    }
    .grid-container {
        display: grid;
        background-color: #1E1F1B;
        padding: 1px;
    }
    .grid-item {
        border: 1px solid rgba(0, 0, 0, 0.8);
        padding: 4px;
        font-size: 30px;
        text-align: center;
    }
    </style>
</head>

<script type="text/javascript" src="./utils.js"></script>
<script>
    // Layout of spells
    const layout = `
        Ralentissement Téléportation Rembobinage Frappe de Xélor Gelure Sablier de Xélor Poussière Temporelle Raulebaque Démotivation Paradoxe Temporel Contre Fuite Désynchronisation
    `
    // Usual/Default Additional Reductions
    const FixedReductionBonuses = [{
        iconSRC : "./images/Rampart.png",
        alt : "RAMPART",
        value : 154
        },{
        iconSRC : "./images/Rampart.png",
        alt : "RAMPART",
        value : 110
        },{
        iconSRC : "./images/Fortification.png",
        alt : "FORTIF",
        value : 220
        },{
        iconSRC : "./images/Valkyr's_Embrace.png",
        alt : "VALKYR",
        value : 132
        },
    ]
    const FinalReductionBonuses = [{
        iconSRC : "./images/Rage.png",
        alt : "RAGE",
        value : 10
        },{
        iconSRC : "./images/Rage.png",
        alt : "RAGE",
        value : 10
        },{
        iconSRC : "./images/Watchdog.png",
        alt : "WATCHDOG",
        value : 15
        },{
        iconSRC : "./images/Feca_Shield.png",
        alt : "F SHIELD",
        value : 35
        },{
        iconSRC : "./images/Ataraxia.png",
        alt : "ATARAXIA",
        value : 75
        },
    ]
    // Globals
    let numberOfBoosts = 0
    let expectedDamage = 0

    let finalFactor = 1
    const activeAdditionalFinalResIDS = []
    let meleeFactor = 1
    let rangeFactor = 1
    let fixedAirRes = 0
    let fixedAdditionalRes = 0
    const activeAdditionalFixedResIDS = []
    let percentAirRes = 0

    const boost = {
        'Slow Down': false,
        'Teleportation': false,
        'Rewind': false,
        "Xelor's Punch": false,
        'Frostbite': false,
        "Xelor's Sandglass": false,
        'Temporal Dust': false,
        'Rhol Bak': false,
        'Loss of Motivation': false,
        'Temporal Paradox': false,
        'Counter': false,
        'Flight': false,
        'Desynchronisation': false,
    }

    // Functions and Methods
    function toggleSpellBoost(spell) {
        const clickedSpell = spell
        if (!canTelefrag(spell)) {return}
        const myNode = document.getElementById(`spellGridItem-${getShortName(spell)}`)
        if (typeof(boost[spell])!=="undefined") {
            boost[spell] = !boost[spell]
        }
        else {
            spell = getVariantOf(spell)
            boost[spell] = !boost[spell]
        }
        if (boost[spell]) {
            myNode.style.setProperty("background-color", "#267E08")
            if (canTelefrag(getVariantOf(clickedSpell))) {
                document.getElementById(`spellGridItem-${getShortName(getVariantOf(clickedSpell))}`).style.setProperty("background-color", "rgba(255,255,255,0.2)")
            }
        }
        else {
            // reset background, also reset for variant if eligible
            myNode.style.setProperty("background-color", "#757674")
            if (canTelefrag(getVariantOf(clickedSpell))) {
                document.getElementById(`spellGridItem-${getShortName(getVariantOf(clickedSpell))}`).style.setProperty("background-color", "#757674")
            }
        }
        updateExpectedDamage()
    }
    function createSpellGrid(layout) {
        const spellGridContainerNode = document.getElementById("spellGridContainer")
        spellGridContainerNode.replaceChildren()
        const columns = layout.reduce((maxCol, line) => Math.max(maxCol, line.length), 0)
        const rows = layout.length
        spellGridContainerNode.style.setProperty('grid-template-columns', "1fr ".repeat(columns))
        spellGridContainerNode.style.setProperty('grid-template-rows', "1fr ".repeat(2*rows))
        for (line of layout) {
            const lineA =[]
            const lineB =[]
            for (spell of line) {
                const myImage = document.createElement("input")
                myImage.setAttribute("id",`spellGridItem-${getShortName(spell)}`)
                if (!canTelefrag(spell)) myImage.style.setProperty("background-color", "rgba(0,0,0,0)")
                else myImage.style.setProperty("background-color", "#757674")
                myImage.classList.add("grid-item")
                myImage.setAttribute("type", "image")
                myImage.setAttribute("src", getImagePath(spell))
                myImage.setAttribute("alt", `[ICON : ${getShortName(spell)}]`)
                myImage.setAttribute("onclick", `toggleSpellBoost("${spell}");`)
                lineA.push(myImage)

                const variantSpell = getVariantOf(spell)
                const myVariantImage = document.createElement("input")
                myVariantImage.setAttribute("id",`spellGridItem-${getShortName(variantSpell)}`)
                if (!canTelefrag(variantSpell)) myVariantImage.style.setProperty("background-color", "rgba(0,0,0,0)")
                else myVariantImage.style.setProperty("background-color", "#757674")
                myVariantImage.classList.add("grid-item")
                myVariantImage.setAttribute("type", "image")
                myVariantImage.setAttribute("src", getImagePath(variantSpell))
                myVariantImage.setAttribute("alt", `[ICON : ${getShortName(variantSpell)}]`)
                myVariantImage.setAttribute("onclick", `toggleSpellBoost("${variantSpell}");`)
                lineB.push(myVariantImage)

            }
            for (node of lineA) {
                spellGridContainerNode.appendChild(node)
            }
            for (let i=0; i< columns - lineA.length; ++i) {
                const node = document.createElement("div")
                node.classList.add("grid-item")
                node.style.setProperty("padding","0px")
                node.style.setProperty("border","0px")
                spellGridContainerNode.appendChild(node)
            }
            for (node of lineB) {
                spellGridContainerNode.appendChild(node)
            }
            for (let i=0; i< columns - lineB.length; ++i) {
                const node = document.createElement("div")
                node.classList.add("grid-item")
                node.style.setProperty("padding","0px")
                node.style.setProperty("border","0px")
                spellGridContainerNode.appendChild(node)
            }
        }
    }
    function toggleAdditionalFixedReduction(nodeID) {
        const myNode = document.getElementById(nodeID)
        if (activeAdditionalFixedResIDS.includes(nodeID)) {
            // Deactivate
            myNode.style.setProperty("background-color", "#757674")
            activeAdditionalFixedResIDS.splice(activeAdditionalFixedResIDS.indexOf(nodeID),1)
            // Fuck you JS, can't even remove an element properly
        }
        else {
            // Activate
            myNode.style.setProperty("background-color", "#267E08")
            activeAdditionalFixedResIDS.push(nodeID)
        }
        updateExpectedDamage()
    }
    function addNewAdditionalFixedReduction() {
        const containerNode = document.getElementById("additionalFixedReductionContainer")
        const width = containerNode.childNodes.length
        const newValue = document.getElementById("additionalFixedReductionItem-CustomInput").value

        // Only work if the new Value is valid (= Number and ParseInt agree on value)
        if (newValue !== "" && Number(newValue)==parseInt(newValue)) {

            // make room for 1 more element on the grid
            containerNode.style.setProperty("grid-template-columns","1fr ".repeat(width +1 ))

            const newNode = document.createElement("div")
            newNode.classList.add("grid-item")
            newNode.setAttribute("id", `additionalFixedReductionItem-${width}`)
            newNode.style.setProperty("background-color", "#757674")

            const newImg = document.createElement("input")
            newImg.setAttribute("type", "image")
            newImg.setAttribute("src", "./images/unknown_shield.png") // Dev Note : Find better icon
            newImg.setAttribute("width", "54px")
            newImg.setAttribute("alt", "[CUSTOM]")
            newImg.setAttribute("onclick",`toggleAdditionalFixedReduction("additionalFixedReductionItem-${width}")`)
            newNode.appendChild(newImg)

            const newText = document.createElement("p")
            newText.style.setProperty("color","#EAEBE7")
            newText.style.setProperty("font-size","16px")
            newText.style.setProperty("text-align","center")
            newText.style.setProperty("margin-top","-8px")
            newText.style.setProperty("margin-left","0px")
            newText.style.setProperty("margin-bottom","-4px")

            const newInput = document.createTextNode(newValue)
            newText.appendChild(newInput)

            newNode.appendChild(newText)

            containerNode.insertBefore(newNode, containerNode.childNodes[width-1])
        }
        else {
            console.log("invalid custom fixed reduction, not adding")
        }
    }
    function fillAdditionalFixedReductionGrid() {
        const containerNode = document.getElementById("additionalFixedReductionContainer")
        containerNode.replaceChildren()
        containerNode.style.setProperty("grid-template-columns","1fr ".repeat(FixedReductionBonuses.length +1 ))
        for (i in FixedReductionBonuses) {
            const newNode = document.createElement("div")
            newNode.classList.add("grid-item")
            newNode.setAttribute("id", `additionalFixedReductionItem-${i}`)
            newNode.style.setProperty("background-color", "#757674")

            const newImg = document.createElement("input")
            newImg.setAttribute("type", "image")
            newImg.setAttribute("src", FixedReductionBonuses[i].iconSRC)
            newImg.setAttribute("alt", FixedReductionBonuses[i].alt)
            newImg.setAttribute("onclick",`toggleAdditionalFixedReduction("additionalFixedReductionItem-${i}")`)
            newNode.appendChild(newImg)

            const newText = document.createElement("p")
            newText.style.setProperty("color","#EAEBE7")
            newText.style.setProperty("font-size","16px")
            newText.style.setProperty("text-align","center")
            newText.style.setProperty("margin-top","-8px")
            newText.style.setProperty("margin-left","0px")
            newText.style.setProperty("margin-bottom","-4px")
            const t = document.createTextNode(FixedReductionBonuses[i].value)
            newText.appendChild(t)

            newNode.appendChild(newText)

            containerNode.appendChild(newNode)
        }
        const newNode = document.createElement("div")
        newNode.classList.add("grid-item")
        newNode.setAttribute("id", 'additionalFixedReductionItem-Custom')
        newNode.style.setProperty("background-color", "#757674")

        const newImg = document.createElement("input")
        newImg.setAttribute("type", "image")
        newImg.setAttribute("src", "./images/New.png")
        newImg.setAttribute("width", "54px")
        newImg.setAttribute("alt", "[ADD]")
        newImg.setAttribute("onclick","addNewAdditionalFixedReduction()")
        newNode.appendChild(newImg)

        const newText = document.createElement("div")
        newText.style.setProperty("margin-top","-20px")
        newText.style.setProperty("margin-bottom","-10px")
        const newInput = document.createElement("input")
        newInput.setAttribute("id", 'additionalFixedReductionItem-CustomInput')
        newInput.setAttribute("type","text")
        newInput.style.setProperty("width","30px")
        newText.appendChild(newInput)

        newNode.appendChild(newText)

        containerNode.appendChild(newNode)
    }
    // Same as fixed (next 3 functions are duplicates of previous 3)
    function toggleAdditionalFinalReduction(nodeID) {
        const myNode = document.getElementById(nodeID)
        if (activeAdditionalFinalResIDS.includes(nodeID)) {
            // Deactivate
            myNode.style.setProperty("background-color", "#757674")
            activeAdditionalFinalResIDS.splice(activeAdditionalFinalResIDS.indexOf(nodeID),1)
            // Fuck you JS, can't even remove an element properly
        }
        else {
            // Activate
            myNode.style.setProperty("background-color", "#267E08")
            activeAdditionalFinalResIDS.push(nodeID)
        }
        updateExpectedDamage()
    }
    function addNewAdditionalFinalReduction() {
        const containerNode = document.getElementById("additionalFinalReductionContainer")
        const width = containerNode.childNodes.length
        const newValue = document.getElementById("additionalFinalReductionItem-CustomInput").value

        // Only work if the new Value is valid (= Number and ParseInt agree on value)
        if (newValue !== "" && Number(newValue)==parseInt(newValue)) {

            containerNode.style.setProperty("grid-template-columns","1fr ".repeat(width +1 ))

            const newNode = document.createElement("div")
            newNode.classList.add("grid-item")
            newNode.setAttribute("id", `additionalFinalReductionItem-${width}`)
            newNode.style.setProperty("background-color", "#757674")

            const newImg = document.createElement("input")
            newImg.setAttribute("type", "image")
            newImg.setAttribute("src", "./images/unknown_shield.png") // Dev Note : Find better icon
            newImg.setAttribute("width", "54px")
            newImg.setAttribute("alt", "[CUSTOM]")
            newImg.setAttribute("onclick",`toggleAdditionalFinalReduction("additionalFinalReductionItem-${width}")`)
            newNode.appendChild(newImg)

            const newText = document.createElement("p")
            newText.style.setProperty("color","#EAEBE7")
            newText.style.setProperty("font-size","16px")
            newText.style.setProperty("text-align","center")
            newText.style.setProperty("margin-top","-8px")
            newText.style.setProperty("margin-left","0px")
            newText.style.setProperty("margin-bottom","-4px")

            const newInput = document.createTextNode(newValue)
            newText.appendChild(newInput)

            newNode.appendChild(newText)

            containerNode.insertBefore(newNode, containerNode.childNodes[width-1])
        }
        else {
            console.log("invalid custom final reduction, not adding")
        }
    }
    function fillAdditionalFinalReductionGrid() {
        const containerNode = document.getElementById("additionalFinalReductionContainer")
        containerNode.replaceChildren()
        containerNode.style.setProperty("grid-template-columns","1fr ".repeat(FinalReductionBonuses.length +1 ))
        for (i in FinalReductionBonuses) {
            const newNode = document.createElement("div")
            newNode.classList.add("grid-item")
            newNode.setAttribute("id", `additionalFinalReductionItem-${i}`)
            newNode.style.setProperty("background-color", "#757674")

            const newImg = document.createElement("input")
            newImg.setAttribute("type", "image")
            newImg.setAttribute("src", FinalReductionBonuses[i].iconSRC)
            newImg.setAttribute("alt", FinalReductionBonuses[i].alt)
            newImg.setAttribute("onclick",`toggleAdditionalFinalReduction("additionalFinalReductionItem-${i}")`)
            newNode.appendChild(newImg)

            const newText = document.createElement("p")
            newText.style.setProperty("color","#EAEBE7")
            newText.style.setProperty("font-size","16px")
            newText.style.setProperty("text-align","center")
            newText.style.setProperty("margin-top","-8px")
            newText.style.setProperty("margin-left","0px")
            newText.style.setProperty("margin-bottom","-4px")
            const t = document.createTextNode(FinalReductionBonuses[i].value)
            newText.appendChild(t)

            newNode.appendChild(newText)

            containerNode.appendChild(newNode)
        }
        const newNode = document.createElement("div")
        newNode.classList.add("grid-item")
        newNode.setAttribute("id", 'additionalFinalReductionItem-Custom')
        newNode.style.setProperty("background-color", "#757674")

        const newImg = document.createElement("input")
        newImg.setAttribute("type", "image")
        newImg.setAttribute("src", "./images/New.png")
        newImg.setAttribute("width", "54px")
        newImg.setAttribute("alt", "[ADD]")
        newImg.setAttribute("onclick","addNewAdditionalFinalReduction()")
        newNode.appendChild(newImg)

        const newText = document.createElement("div")
        newText.style.setProperty("margin-top","-20px")
        newText.style.setProperty("margin-bottom","-10px")
        const newInput = document.createElement("input")
        newInput.setAttribute("id", 'additionalFinalReductionItem-CustomInput')
        newInput.setAttribute("type","text")
        newInput.style.setProperty("width","30px")
        newText.appendChild(newInput)

        newNode.appendChild(newText)

        containerNode.appendChild(newNode)
    }
    function fillAdditionalReductionGrids() {
        fillAdditionalFixedReductionGrid()
        fillAdditionalFinalReductionGrid()
    }
    function validDamage(floatDamage) {
        return  Math.max(Math.floor(floatDamage),0)
    }
    function recalculateAdditionalFixedRes() {
        let r = 0
        for (nodeID of activeAdditionalFixedResIDS) {
            r += Number(document.getElementById(nodeID).childNodes[1].childNodes[0].textContent)
        }
        fixedAdditionalRes = r
    }
    function recalculateFinalFactor() {
        let factor = 1
        for (nodeID of activeAdditionalFinalResIDS) {
            // take the value, multiply
            factor *= 1-(Number(document.getElementById(nodeID).childNodes[1].childNodes[0].textContent)/100)
        }
        finalFactor = factor
    }
    function recalculateExpectedDamages() {
        // Dégâts=(368-RéFix)x(1-Ré%Air/100)x(1-Ré%Final/100)x(2xNombreBoosts-1)
        refreshAllValues()
        refreshBoosts()
        recalculateFinalFactor()
        recalculateAdditionalFixedRes()
        expectedDamage_melee = validDamage((368 - (fixedAirRes + fixedAdditionalRes)) * (1 - percentAirRes/100) * (finalFactor * meleeFactor) * (2 * numberOfBoosts - 1))
        expectedDamage_range = validDamage((368 - (fixedAirRes + fixedAdditionalRes)) * (1 - percentAirRes/100) * (finalFactor * rangeFactor) * (2 * numberOfBoosts - 1))
    }
    function updateExpectedDamageDisplays() {
        const myNodeM = document.getElementById("expectedDamageNode-Melee")
        myNodeM.textContent = String(expectedDamage_melee)
        const myNodeR = document.getElementById("expectedDamageNode-Range")
        myNodeR.textContent = String(expectedDamage_range)
    }
    function updateExpectedDamage() {
        recalculateExpectedDamages()
        updateExpectedDamageDisplays()
    }
    function refreshBoosts() {
        s = 0
        for (spell in boost) {
            s+= boost[spell] ? 1 : 0
        }
        numberOfBoosts = s
    }
    function refreshMeleeRes() {
        const myNode = document.getElementById("resMelee")
        meleeFactor = 1 - Number(myNode.value)/100
    }
    function refreshRangeRes() {
        const myNode = document.getElementById("resRange")
        rangeFactor = 1 - Number(myNode.value)/100
    }
    function refreshFixedAirRes() {
        const myNode = document.getElementById("fixedAirRes")
        fixedAirRes = Number(myNode.value)
    }
    function refreshPercentAirRes() {
        const myNode = document.getElementById("percentAirRes")
        percentAirRes = Number(myNode.value)
    }

    function refreshAllValues() {
        refreshMeleeRes()
        refreshRangeRes()
        refreshFixedAirRes()
        refreshPercentAirRes()
    }

</script>



<body style="background-color: #1E1F1B; font-family: 'Courier New', Courier, monospace;">
    <div style="display: grid; justify-items : center;  width : 50%;">
        <div class="grid-container" id ="damageGridContainer" style ="grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; width : 80%">
            <div class="grid-item" id="expectedDamageParentNode-Melee" style="background-color : #757674;">
                <img src="./images/melee.png" alt ='[MELEE ICON]' style="float:left;padding-left: 20%;">
                <div id="expectedDamageNode-Melee">0</div>
            </div>
            <div class="grid-item" id="expectedDamageParentNode-Range" style="background-color : #757674;">
                <img src="./images/range.png" alt ='[RANGE ICON]' style="float:left;padding-left: 20%;">
                <div id="expectedDamageNode-Range">0</div>
            </div>
        </div>
    </div>
    
    <div style="display : grid; justify-items : center; width : 50%">
        <div>
            <label for="percentAirRes" style="color : #EAEBE7;">% Air Res</label>
            <input type="text" id="percentAirRes" oninput="updateExpectedDamage()" style="width : 40px;">
            <label for="fixedAirRes" style="color : #EAEBE7;">&nbsp&nbsp Air Res</label>
            <input type="text" id="fixedAirRes" oninput="updateExpectedDamage()" style="width : 40px;">
            <br>

            <label for="resMelee" style="color : #EAEBE7;">% Melee &nbsp</label>
            <input type="text" id="resMelee" oninput="updateExpectedDamage()" style="width : 40px;">
            <label for="resRange" style="color : #EAEBE7;">&nbsp&nbsp % Range</label>
            <input type="text" id="resRange" oninput="updateExpectedDamage()" style="width : 40px;"><br>
        </div>
    </div>

    <label for="additionalFixedReductionContainer" style="color : #EAEBE7;">Fixed Reductions</label>
    <div class="grid-container" id="additionalFixedReductionContainer" style="width: 0px;"></div>
    <label for="additionalFinalReductionContainer" style="color : #EAEBE7;">Final Reductions</label>
    <div class="grid-container" id="additionalFinalReductionContainer" style="width: 0px;"></div>
    <br>

    <div class="spell-grid-container" id ="spellGridContainer" style = "width : 0px; "></div>

</body>
<script>
// Loading and Init
    const layoutArray = parseLayoutString(layout)
    createSpellGrid(layoutArray)
    fillAdditionalReductionGrids()
</script>
</html>